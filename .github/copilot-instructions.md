# FitMatch Copilot Instructions

## Architecture Overview

**FitMatch** is a full-stack outfit recommendation and community platform (Express.js + MySQL + vanilla JavaScript).

### Core Subsystems

1. **Authentication & User Management** (`server.js` lines 67-180)
   - JWT tokens stored in HttpOnly cookies
   - `authMiddleware` validates all protected endpoints
   - User avatars stored as Base64 strings in `AvatarBase64` column
   - Password hashing via `bcrypt`

2. **Outfit Generation & Management** (`public/outfit.js`)
   - Three-tier clothing taxonomy: Style → Category (top/bottom/hat) → Color
   - Uses `MAP_STYLE` and `MAP_COLOR` objects to normalize frontend choices to file paths
   - `clothingData.json` auto-generated by `generateClothingData.js` (scans `/public/clothing/` directory structure)
   - Outfits are combinations of hat + top + bottom images stored in MySQL `outfits` table

3. **Favorites & History Tracking**
   - `user_favorites`: User-outfit associations with timestamps
   - `outfitHistory`: Tracks outfit views per user, joined with outfit metadata for frontend display

4. **Message Board** (`server.js` lines 474+, `public/messageboard.js`)
   - Posts and comments with nested like counts
   - Posts table: `PostID, UserID, Content, ImageURL, CreatedAt`
   - Likes tracked separately in `posts_likes` and `comments_likes` tables

## Critical Development Patterns

### Frontend-Backend Data Flow

**Tag System:**
- Frontend loads tags via `/get-all-tags` (no auth required)
- Tags have `type` (color, style, etc.), `key` (programmatic), and `label` (display)
- Tags are rendered dynamically in `outfit.js` via `renderTagsByType()`

**Outfit Generation:**
- When user selects color/style tags, `generateOutfit(style, color)` picks random images
- Uses `MAP_STYLE` and `MAP_COLOR` to convert tag keys to clothing folder paths
- `pickRandom(style, category, color)` loads from `clothingData.json`

**User Identification:**
- Protected endpoints extract `req.user.userId` from JWT (set by `authMiddleware`)
- JWT payload: `{ userId: user.UserID, username: user.Username }`
- Credentials in fetch requests: `{ credentials: 'include' }`

### Database Schema Patterns

**Key Constraint:** `AvatarBase64` column in `users` table stores Base64-encoded avatar images (watch for Payload Too Large errors with large images in `/update-user`)

**Tag Design:** `UNIQUE KEY ux_tags_type_key (type, key)` ensures one key per tag type - important when inserting test data

**Outfit Storage:** Unlike image files (stored on disk in `/public/clothing/`), outfit combinations are persisted in `outfits` table with `ImageURL` pointing to generated/static images

## API Endpoint Reference

### User & Auth
- `POST /authenticate` - Login (no auth needed, sets JWT cookie)
- `POST /user-register` - Register
- `GET /getUserData` - Current user data (protected)
- `POST /update-user` - Update user profile including avatar (protected)
- `POST /logout`

### Outfits
- `GET /get-all-tags` - All available tags
- `POST /save-outfit` - Persist generated outfit (not auth protected in current implementation)
- `GET /get-outfit/:id` - Fetch specific outfit by ID
- `POST /add-history` - Log outfit view (protected)
- `GET /get-history` - Fetch user's recent outfits (protected)

### Favorites
- `GET /get-user-favorites` - User's saved outfits (protected)
- `POST /save-favorite` - Add outfit to favorites (protected)
- `POST /delete-favorite` - Remove from favorites (protected)
- `GET /check-favorite?outfitID=X` - Check if already favorited (protected)

### Message Board (`/api/messages*`)
- `GET /api/messages` - All posts with comment counts
- `POST /api/messages` - Create post with image upload (protected)
- `POST /api/messages/:id/comment` - Add comment (protected)
- `POST /api/messages/:id/toggle-like` - Like post (protected)
- Similar endpoints for comment likes and deletions

## Key Files & Patterns

| File | Purpose |
|------|---------|
| `server.js` | Express routes, database queries, JWT/auth middleware |
| `public/outfit.js` | Outfit generation UI, tag rendering, favorite/history management |
| `public/login.js` | Authentication UI, session check via `/getUserData` |
| `public/messageboard.js` | Message board rendering and CRUD |
| `generateClothingData.js` | Scans clothing directory, outputs `clothingData.json` |
| `fitmatchDB.sql` | Schema definition (run once to initialize) |
| `public/clothing/` | File-system clothing images (5 styles × 3 categories × 3 colors) |
| `mine.env` | Environment variables: `DB_HOST`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`, `JWT_SECRET` |

## Running & Debugging

**Start Server:**
```bash
npm install
node server.js
```
Server runs on `http://localhost:3000`

**Initialize Database:**
```bash
mysql -u <DB_USER> -p <DB_NAME> < fitmatchDB.sql
```

**Regenerate Clothing Data Index:**
```bash
node generateClothingData.js
```
Outputs `public/clothingData.json` (run if clothing folder structure changes)

**Environment Setup:**
Create `mine.env` in project root with MySQL credentials and JWT secret

## Common Gotchas

1. **JWT Cookie Issues:** Endpoints check `req.cookies.token` - verify HttpOnly cookie is being set during login
2. **Base64 Avatar Size:** Large Base64 strings can exceed MySQL `max_allowed_packet` (increase if avatar upload fails with "Payload Too Large")
3. **Clothing Path Mapping:** `MAP_STYLE` and `MAP_COLOR` must match actual folder names in `/public/clothing/` - mismatch causes "undefined" image paths
4. **clothingData.json Staleness:** Run `generateClothingData.js` after adding/removing clothing images
5. **Tag Type Uniqueness:** Database enforces unique (type, key) pairs - duplicate inserts will fail silently on conflict
